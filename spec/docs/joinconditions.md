# Joins

A [=referencing object map=] allows using the subject generated by the [=subject map=] (`rml:SubjectMap`) of the referenced [=triples map=] (`rml:TriplesMap`).
Since the two [=triples maps=] may be based on different [=logical sources=] (`rml:LogicalSource`), this may require a [=join=] between the [=logical sources=]. This is not restricted to 1:1 joins.

## Referencing Object Map

A <dfn>referencing object map</dfn> (`rml:ReferencingObjectMap`) is represented by a resource that MUST have:

* exactly one [=parent triples map=] (`rml:parentTriplesMap`) property,
  whose value MUST be a [=triples map=], known as the referencing object map's <dfn>parent triples map</dfn>.
* one or more join condition (`rml:joinCondition`) properties, whose values MUST be [=join conditions=].

The [=referencing object map=] causes the generation of new [=object=] which is constructed with the [=subject=] generated by evaluating the [=parent triples map=].

<aside class="example" id="example-referencing-object-map" title="Usage of referencing object map">

This example shows a [=referencing object map=] as part of a [=predicate-object map=] in a [=triples map=] mapping the `ex:hasThumbnail` [=property=] of the image.
Since the source data for the thumbnail is part of the same [=logical iteration=] as for the image, the [=logical source=] is identical, and thus [=effectively equal=], to the [=logical source=] of the [=parent triples map=], and no [=join condition=] is needed.

<aside class="ex-mapping">

```turtle
<#ImageTriplesMap>
  rml:predicateObjectMap [
    rml:predicate ex:hasThumbnail ;
    rml:objectMap [
      rml:parentTriplesMap <#ThumbnailTriplesMap> ;
    ] ;
  ] .

<#ThumbnailTriplesMap>
  rml:logicalSource <#ImageLogicalSource> ;
  rml:subjectMap [
    rml:reference "$.Thumbnail.Url" ;
    rml:termType rr:IRI ;
  ] .
```

</aside>

The following RDF triples are generated by the [=RML mapping=] above.

<aside class="ex-output">

```turtle
<http://data.example.com/image/116> ex:hasThumbnail <http://data.example.com/image/116/thumbnail> .
```

</aside>

</aside>

## Join Condition

A <dfn data-lt="join">join condition</dfn> is represented by a resource that has exactly one value for each of the following two properties:

* a child map (`rml:childMap`) property, whose value is a [=child map=].<br> A <dfn>child map</dfn> (`rml:ChildMap`) is an [=expression map=] which MUST be evaluated against the [=logical source=] of the [=triples map=] that contains the [=referencing object map=], i.e. the current [=triples map=], or it should have a [=constant value=].

* a parent map (`rml:parentMap`) property, whose value is a [=parent map=].<br> A <dfn>parent map</dfn> (`rml:ParentMap`) is an [=expression map=], which MUST be evaluated against the [=logical source=] of the [=referencing object map=]'s [=parent triples map=], i.e. the referenced [=triples map=], or it should have a [=constant value=].

If the the [=logical source=] of the [=triples map=] that contains the [=referencing object map=] and the [=logical source=] of the [=referencing object map=]'s [=parent triples map=] are not [=effectively equal=], then the referencing object map MUST have one or more [=join conditions=].

A [=join condition=] is satisfied if the result of evaluating the [=child map=] against the [=logical source=] of the current [=triples map=] is equal to the result of evaluating the [=parent map=] against the [=logical source=] of the referenced [=triples map=].

If a [=referencing object map=] has multiple [=join conditions=], then all of them MUST be satisfied for the referencing object map to be evaluated.

A [=mapping component=] is <dfn>effectively equal</dfn> to another [=mapping component=] if they are identical, or if all their corresponding [=effective properties=] have the same values, recursively comparing values that are [=resources=] that have [=properties=] as well.

An <dfn>effective property</dfn> of a [=mapping component=] is a [=property=] that has an effect on the [=mapping process=].

<aside class="note">
The effective properties of a mapping component are the properties that are used in the mapping process, and are defined by this specification or other specifications that extend this specification.
</aside>

<aside class="example" id="example-join-condition" title="Usage of join condition">

This example shows a [=referencing object map=] as part of a [=predicate-object map=], where the [=logical sources=] of the two [=triples maps=] are not [=effectively equal=]. Therefore, a [=join condition=] is needed to join the two [=logical iterations=].

<aside class="ex-mapping">

```turtle
<#AlbumTriplesMap>
  rml:predicateObjectMap [
    rml:predicate ex:hasImage ;
    rml:objectMap [
      rml:parentTriplesMap <#ImageTriplesMap> ;
      rml:joinCondition [
        rml:childMap [
          rml:reference "$.Images[*].ID" ;
        ] ;
        rml:parentMap [
          rml:reference "$.ID" ;
        ] ;
      ] ;
    ] ;
  ] .
```

</aside>

The following RDF triples are generated by the [=RML mapping=] above, since the first `ID` field in the `Images` array of the `album.json` input source is joined with the `ID` field in the `images.json` input source.

<aside class="ex-output">

```turtle
<http://data.example.com/album/43> ex:hasImage <http://data.example.com/image/116> .
```

</aside>

</aside>

<aside class="example" id="example-effectively-equal" title="Reference object map for non-identical, but effectively equal, logical sources">

This example shows a [=referencing object map=] as part of a [=predicate-object map=], where the [=logical sources=] of the two [=triples maps=] are not identical, but are [=effectively equal=]. Therefore, no [=join condition=] is needed to join the two [=logical iterations=].

<aside class="ex-mapping">

```turtle
<#ImageTriplesMap>
  rml:predicateObjectMap [
    rml:predicate ex:hasThumbnail ;
    rml:objectMap [
      rml:parentTriplesMap <#ThumbnailTriplesMap2> ;
    ] ;
  ] .

<#ThumbnailTriplesMap2>
  rml:logicalSource [
    rdfs:label "Thumbnail source" ;
    rml:source [
      a rml:RelativePathSource ;
      rml:root rml:MappingDirectory ;
      rml:path "images.json" ;
    ] ;
    rml:iterator "$.Images[*]" ;
    rml:referenceFormulation rml:JSONPath ;
  ] ;
  rml:subjectMap [
    rml:reference "$.Thumbnail.Url" ;
    rml:termType rr:IRI ;
  ] .
```

</aside>

The rml:logicalSource of `<#ThumbnailTriplesMap2>` is different from the rml:logicalSource `<#ImageLogicalSource>` of `<#ImageTriplesMap>` as defined in [[[#example-simple-mappings]]], but they are [=effectively equal=], since all effective properties are the same. The following properties are effective in this case:

* `rml:source` - defined in [[RML-IO]]
  * `rml:root` - defined in [[RML-IO]]
  * `rml:path` - defined in [[RML-IO]]
* `rml:iterator` - the [=iterator=]
* `rml:referenceFormulation` - the [=reference formulation=]

The `rdfs:label` is not an `effective property` and is not considered in the comparison.

Note also that the [=logical source=] [=node=] from [[[#example-simple-mappings]]] is named with an [=IRI=] `<#ImageLogicalSource>`, and the [=logical source=] for `<#ThumbnailTriplesMap2>` is named with a [=blank node=]. The name of a [=resource=] has no effect on the [=mapping process=] and is not considered in the comparison.

</aside>

### Shortcuts for reference-valued child map and parent map

If the [=child map=] is a [=reference-valued expression map=], then the `rml:child` shortcut could be used.

Similarly, if the [=parent map=] is a [=reference-valued expression map=], then the `rml:parent` shortcut could be used.

Occurrences of these properties MUST be treated exactly as if the following triples were present in the [=mapping graph=] instead:

| Triple involving reference shortcut property | Replacement triples                      |
| :--------------------------------------------| :----------------------------------------|
| `?x rml:child ?y.`                           | `?x rml:childMap [ rml:reference ?y ].`  |
| `?x rml:parent ?y.`                          | `?x rml:parentMap [ rml:reference ?y ].` |


<aside class="example" id="example-join-condition-shortcut-properties" title="Usage of shortcut properties for child map and parent map">

<aside class="ex-mapping">

```turtle
<#AlbumTriplesMap>
  rml:predicateObjectMap [
    rml:predicate ex:hasImage ;
    rml:objectMap [
      rml:parentTriplesMap <#ImageTriplesMap> ;
      rml:joinCondition [
        rml:child "$.Images[*].ID" ;
        rml:parent "$.ID" ;
      ] ;
    ] ;
  ] .
```

</aside>

</aside>
